<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RPG Roguelike — Single File</title>
<style>
  html,body{height:100%;margin:0;background:#111;color:#ddd;font-family:Verdana}
  #wrap{height:100%;display:flex;align-items:center;justify-content:center}
  canvas{border:0.45rem outset #555;background:#222;display:block}
  #hud{position:absolute;top:10px;left:12px;font-size:14px;color:#fff}
  #menu,#death{position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;background:rgba(0,0,0,0.6)}
  button{padding:8px 12px;margin:6px;cursor:pointer;font-size:16px}
  .small{font-size:13px;color:#bbb}
</style>
</head>

<body>
<div id="wrap">
  <canvas id="game" width="900" height="800"></canvas>

  <div id="hud"></div>

  <div id="menu">
    <h2>RPG Roguelike</h2>
    <div class="small">WASD mover • Mouse mirar/atacar • Prossiga sala a sala</div>
    <button id="startBtn">Iniciar Aventura</button>
    <div class="small">Salas geradas, inimigos acumulativos, loot e mini-bosses.</div>
  </div>

  <div id="death" style="display:none">
    <h2>MORTO</h2>
    <div id="deathStats" class="small" style="margin-bottom:8px"></div>
    <button id="restartBtn">Recomeçar</button>
  </div>
</div>

<script>
/* ===========================================================
   RPG ROGUELIKE — UMA ÚNICA PÁGINA / ARQUIVO
   - Mapa procedural de salas
   - Mesma estética e tipos de inimigos
   - Itens, progressão, mini-bosses
   - Roguelike simples
   =========================================================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const HUD = document.getElementById("hud");

const menu = document.getElementById("menu");
const death = document.getElementById("death");
const deathStats = document.getElementById("deathStats");
const startBtn = document.getElementById("startBtn");
const restartBtn = document.getElementById("restartBtn");

let state = "menu"; // menu | game | death
let last = 0;

/* ===========================================================
   PLAYER
=========================================================== */
let player;
function createPlayer(){
  player = {
    x:450, y:400, w:22, h:22,
    hp:12, hpMax:12,
    atk:4, def:1, crit:0.1,
    speed:140,
    facing:0,
    atkCD:0,
    pressing:{up:false,down:false,left:false,right:false},
    inventory:[]
  };
}

/* ===========================================================
   MUNDO / SALAS
=========================================================== */
let room = { index:1, cleared:false };
let enemies = {};
let bullets = {};
let pickups = {};

function generateRoom(){
  room = { index: room.index+1, cleared:false };
  enemies = {};
  bullets = {};
  pickups = {};

  const amount = 3 + Math.floor(room.index*0.5);

  for(let i=0;i<amount;i++){
    spawnEnemyRandom();
  }

  // mini boss
  if(room.index % 3 === 0){
    spawnMiniBoss();
  }
}

function spawnEnemyRandom(){
  const pool = ["basic"];
  if(room.index >=2) pool.push("fast");
  if(room.index >=3) pool.push("tank");
  if(room.index >=4) pool.push("ranged");
  if(room.index >=5) pool.push("elite");

  const type = pool[Math.floor(Math.random()*pool.length)];
  spawnEnemy(type);
}

const ENEMY_TYPES = {
  basic: {life:4, speed:60, color:"maroon"},
  fast: {life:3, speed:110, color:"orangered"},
  tank: {life:10, speed:35, color:"darkred"},
  ranged:{life:5, speed:40, color:"purple", ranged:true},
  elite:{life:8, speed:70, color:"goldenrod"},
  miniboss:{life:20, speed:55, color:"black", boss:true}
};

function spawnMiniBoss(){
  spawnEnemy("miniboss");
}

function spawnEnemy(type){
  const spec = ENEMY_TYPES[type];
  const id = Math.random().toString(36).slice(2);

  enemies[id] = {
    id, type,
    x: Math.random()*800+50,
    y: Math.random()*700+50,
    w:28, h:28,
    life: spec.life,
    color: spec.color,
    ranged: spec.ranged || false,
    boss: spec.boss || false,
    speed: spec.speed
  };
}

/* ===========================================================
   TIROS
=========================================================== */
function spawnBullet(x,y,angle,damage,owner){
  const id = Math.random().toString(36).slice(2);
  bullets[id] = {
    id, x,y, w:6, h:6,
    xs: Math.cos(angle)*420,
    ys: Math.sin(angle)*420,
    damage, owner
  };
}

/* inimigos shoot */
function spawnEnemyBullet(x,y,angle){
  spawnBullet(x,y,angle,2,"enemy");
}

/* ===========================================================
   LOOT
=========================================================== */
function spawnPickup(type,x,y){
  const id = Math.random().toString(36).slice(2);
  pickups[id] = {
    id, x,y, w:14, h:14,
    type
  };
}

function dropLoot(e){
  const r = Math.random();
  if(r<0.3) spawnPickup("heal",e.x,e.y);
  else if(r<0.5) spawnPickup("atk",e.x,e.y);
  else if(r<0.7) spawnPickup("def",e.x,e.y);
  else if(r<0.75) spawnPickup("crit",e.x,e.y);
}

/* ===========================================================
   UPDATE
=========================================================== */
function update(dt){
  // player
  let dx = 0, dy = 0;
  if(player.pressing.up) dy -= 1;
  if(player.pressing.down) dy += 1;
  if(player.pressing.left) dx -= 1;
  if(player.pressing.right) dx += 1;

  const mag = Math.hypot(dx,dy);
  if(mag>0){ dx/=mag; dy/=mag; }

  player.x += dx * player.speed * dt;
  player.y += dy * player.speed * dt;

  player.x = Math.max(20,Math.min(880,player.x));
  player.y = Math.max(20,Math.min(780,player.y));

  if(player.atkCD>0) player.atkCD -= dt;

  // enemies
  for(const id in enemies){
    const e = enemies[id];
    const a = Math.atan2(player.y-e.y, player.x-e.x);

    e.x += Math.cos(a)*e.speed*dt;
    e.y += Math.sin(a)*e.speed*dt;

    // ranged attack
    if(e.ranged){
      if(!e.cd) e.cd = 1+Math.random()*1;
      e.cd -= dt;
      if(e.cd<=0){
        spawnEnemyBullet(e.x,e.y,a);
        e.cd = 1.5+Math.random()*2;
      }
    }
  }

  // bullets
  for(const id in bullets){
    const b = bullets[id];
    b.x += b.xs * dt;
    b.y += b.ys * dt;

    if(b.x <0 || b.x>900 || b.y<0 || b.y>800){
      delete bullets[id];
      continue;
    }

    // hit enemy
    if(b.owner==="player"){
      for(const eid in enemies){
        const e = enemies[eid];
        if(rect(b,e)){
          e.life -= b.damage;
          delete bullets[id];

          if(e.life<=0){
            dropLoot(e);
            delete enemies[eid];

            // sala limpa?
            if(Object.keys(enemies).length===0){
              room.cleared = true;
            }
          }
          break;
        }
      }
    }

    // hit player
    if(b.owner==="enemy" && rect(b,player)){
      delete bullets[id];
      const dmg = Math.max(1,b.damage - player.def);
      player.hp -= dmg;

      if(player.hp<=0){
        gameOver();
        return;
      }
    }
  }

  // pickups
  for(const id in pickups){
    const p = pickups[id];
    if(rect(p,player)){
      if(p.type==="heal") player.hp = Math.min(player.hpMax, player.hp+4);
      if(p.type==="atk") player.atk++;
      if(p.type==="def") player.def++;
      if(p.type==="crit") player.crit += 0.05;

      delete pickups[id];
    }
  }
}

/* ===========================================================
   DRAW
=========================================================== */
function draw(){
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,900,800);

  // room index
  ctx.fillStyle="#666";
  ctx.font="20px Verdana";
  ctx.fillText("Sala "+room.index, 20,30);

  // door (próxima sala)
  if(room.cleared){
    ctx.fillStyle="lightblue";
    ctx.fillRect(420,10,60,20);
  }

  // player
  ctx.fillStyle="lightgreen";
  ctx.fillRect(player.x-player.w/2, player.y-player.h/2, player.w, player.h);

  // enemies
  for(const id in enemies){
    const e = enemies[id];
    ctx.fillStyle=e.color;
    ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h);
  }

  // bullets
  for(const id in bullets){
    const b = bullets[id];
    ctx.fillStyle = b.owner==="player"?"white":"red";
    ctx.fillRect(b.x-b.w/2,b.y-b.h/2,b.w,b.h);
  }

  // pickups
  for(const id in pickups){
    const p = pickups[id];
    ctx.fillStyle = p.type==="heal"?"lime":
                    p.type==="atk"?"yellow":
                    p.type==="def"?"cyan":"violet";
    ctx.fillRect(p.x-p.w/2,p.y-p.h/2,p.w,p.h);
  }

  // HUD
  HUD.innerHTML =
    `HP: ${player.hp}/${player.hpMax}<br>`+
    `ATK ${player.atk} • DEF ${player.def} • CRIT ${(player.crit*100).toFixed(0)}%<br>`+
    (room.cleared?"Porta aberta → Vá ao topo":"");
}

/* ===========================================================
   HELPERS
=========================================================== */
function rect(a,b){
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < b.y + b.h &&
         a.y + a.h > b.y;
}

function gameOver(){
  state="death";
  death.style.display="flex";
  menu.style.display="none";
  deathStats.innerHTML = `Você chegou até a sala ${room.index}.`;
}

/* ===========================================================
   LOOP
=========================================================== */
function loop(ts){
  const dt = (ts-last)/1000;
  last = ts;

  if(state==="game"){
    update(dt);
    draw();

    // porta: próxima sala
    if(room.cleared && player.y<30 && player.x>420 && player.x<480){
      generateRoom();
      player.x=450; player.y=740;
    }
  }

  requestAnimationFrame(loop);
}

/* ===========================================================
   INPUT
=========================================================== */
document.addEventListener("keydown",e=>{
  if(state!=="game") return;
  if(e.key==="w") player.pressing.up=true;
  if(e.key==="s") player.pressing.down=true;
  if(e.key==="a") player.pressing.left=true;
  if(e.key==="d") player.pressing.right=true;
});

document.addEventListener("keyup",e=>{
  if(state!=="game") return;
  if(e.key==="w") player.pressing.up=false;
  if(e.key==="s") player.pressing.down=false;
  if(e.key==="a") player.pressing.left=false;
  if(e.key==="d") player.pressing.right=false;
});

canvas.addEventListener("mousedown",e=>{
  if(state!=="game") return;
  if(player.atkCD>0) return;

  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const a = Math.atan2(my-player.y, mx-player.x);
  const isCrit = Math.random()<player.crit;
  const dmg = isCrit ? player.atk*2 : player.atk;

  spawnBullet(player.x, player.y, a, dmg, "player");

  player.atkCD = 0.25;
});

/* ===========================================================
   START
=========================================================== */
startBtn.onclick = ()=>{
  state="game";
  menu.style.display="none";
  death.style.display="none";

  createPlayer();
  room = {index:1, cleared:false};
  generateRoom();
};

restartBtn.onclick = startBtn.onclick;

requestAnimationFrame(loop);
</script>
</body>
</html>
