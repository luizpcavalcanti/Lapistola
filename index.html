<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Starfall Outpost</title>
<style>
    body {
        background: #111;
        margin: 0;
        overflow: hidden;
        font-family: monospace;
        color: white;
    }
    #gameCanvas {
        background: #1a1a1a;
        display: block;
        margin: 0 auto;
    }
    #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 18px;
        color: white;
        z-index: 10;
    }
    #upgradeMenu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        padding: 20px;
        border: 2px solid white;
        display: none;
        z-index: 20;
    }
    .upgradeBtn {
        display: block;
        margin: 10px 0;
        padding: 10px;
        background: #333;
        color: white;
        border: 1px solid white;
        cursor: pointer;
    }
</style>
</head>
<body>

<div id="ui">Wave: <span id="waveNumber">1</span> | HP: <span id="hpText">100</span></div>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="upgradeMenu">
    <h2>Choose an Upgrade</h2>
    <div id="upgradeOptions"></div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let keys = {};
let gameRunning = false;

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

let player = {
    x: 400,
    y: 500,
    size: 20,
    speed: 3,
    hp: 100,
    fireRate: 400,
    lastShot: 0,
    damage: 10
};

let projectiles = [];
let enemies = [];
let meteors = [];
let wave = 1;
let waveActive = false;

function spawnWave() {
    waveActive = true;
    let count = 5 + wave * 2;

    for (let i = 0; i < count; i++) {
        enemies.push({
            x: Math.random()*800,
            y: -Math.random()*300 - 50,
            size: 18,
            speed: 1 + wave * 0.1,
            hp: 20 + wave*5
        });
    }

    // also meteors
    for (let i = 0; i < 3 + wave; i++) {
        meteors.push({
            x: Math.random()*800,
            y: -Math.random()*400 - 100,
            size: 14 + Math.random()*10,
            speed: 2 + wave*0.15
        });
    }

    document.getElementById("waveNumber").textContent = wave;
}

function shoot() {
    let now = performance.now();
    if (now - player.lastShot < player.fireRate) return;
    player.lastShot = now;

    projectiles.push({
        x: player.x,
        y: player.y - 10,
        dy: -6,
        size: 4
    });
}

function updatePlayer() {
    if (keys["ArrowLeft"] || keys["a"]) player.x -= player.speed;
    if (keys["ArrowRight"] || keys["d"]) player.x += player.speed;
    if (keys["ArrowUp"] || keys["w"]) player.y -= player.speed;
    if (keys["ArrowDown"] || keys["s"]) player.y += player.speed;

    if (player.x < 10) player.x = 10;
    if (player.x > 790) player.x = 790;
    if (player.y < 10) player.y = 10;
    if (player.y > 590) player.y = 590;

    if (keys[" "]) shoot();
}

function updateProjectiles() {
    projectiles = projectiles.filter(p => p.y > -20);
    for (let p of projectiles) p.y += p.dy;
}

function updateEnemies() {
    enemies = enemies.filter(e => e.hp > 0);
    for (let e of enemies) {
        e.y += e.speed;

        if (dist(e.x, e.y, player.x, player.y) < e.size + player.size) {
            player.hp -= 10;
            e.hp = 0;
            if (player.hp <= 0) gameOver();
        }

        for (let p of projectiles) {
            if (dist(e.x, e.y, p.x, p.y) < e.size + p.size) {
                e.hp -= player.damage;
                p.y = -999;
            }
        }
    }

    if (enemies.length === 0 && meteors.length === 0 && waveActive) {
        waveActive = false;
        openUpgradeMenu();
    }
}

function updateMeteors() {
    meteors = meteors.filter(m => m.y < 700);
    for (let m of meteors) {
        m.y += m.speed;
        m.x += Math.sin(m.y*0.02)*2;

        if (dist(m.x, m.y, player.x, player.y) < m.size + player.size) {
            player.hp -= 20;
            m.y = 999;
            if (player.hp <= 0) gameOver();
        }
    }
}

function draw() {
    ctx.clearRect(0,0,800,600);

    // player
    ctx.fillStyle = "cyan";
    ctx.fillRect(player.x - player.size/2, player.y - player.size/2, player.size, player.size);

    // projectiles
    ctx.fillStyle = "yellow";
    for (let p of projectiles)
        ctx.fillRect(p.x-2, p.y-10, 4, 10);

    // enemies
    ctx.fillStyle = "red";
    for (let e of enemies)
        ctx.fillRect(e.x - e.size/2, e.y - e.size/2, e.size, e.size);

    // meteors
    ctx.fillStyle = "orange";
    for (let m of meteors)
        ctx.beginPath(), ctx.arc(m.x, m.y, m.size, 0, Math.PI*2), ctx.fill();
}

function dist(x1,y1,x2,y2){
    return Math.hypot(x1-x2, y1-y2);
}

function loop() {
    if (!gameRunning) return;

    updatePlayer();
    updateProjectiles();
    updateEnemies();
    updateMeteors();
    draw();

    document.getElementById("hpText").textContent = player.hp;

    requestAnimationFrame(loop);
}

function openUpgradeMenu() {
    const menu = document.getElementById("upgradeMenu");
    const options = document.getElementById("upgradeOptions");

    const upgrades = [
        {name:"+10 HP", apply:()=>player.hp+=10},
        {name:"Faster Fire", apply:()=>player.fireRate=Math.max(100,player.fireRate-50)},
        {name:"+2 Damage", apply:()=>player.damage+=2},
        {name:"+1 Speed", apply:()=>player.speed+=0.5}
    ];

    // pick 3 random
    let picks = [];
    while (picks.length < 3) {
        let u = upgrades[Math.floor(Math.random()*upgrades.length)];
        if (!picks.includes(u)) picks.push(u);
    }

    options.innerHTML = "";

    picks.forEach(upg => {
        let btn = document.createElement("button");
        btn.className = "upgradeBtn";
        btn.textContent = upg.name;
        btn.onclick = () => {
            upg.apply();
            menu.style.display = "none";
            wave++;
            spawnWave();
        };
        options.appendChild(btn);
    });

    menu.style.display = "block";
}

function gameOver() {
    alert("Game Over â€” survived " + wave + " waves");
    location.reload();
}

function startGame() {
    gameRunning = true;
    spawnWave();
    loop();
}

startGame();
</script>

</body>
</html>
